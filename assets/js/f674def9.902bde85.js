"use strict";(self.webpackChunknlp_docs=self.webpackChunknlp_docs||[]).push([[9008],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>f});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=r.createContext({}),l=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=l(e.components);return r.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,c=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),d=l(n),f=o,m=d["".concat(c,".").concat(f)]||d[f]||u[f]||a;return n?r.createElement(m,s(s({ref:t},p),{},{components:n})):r.createElement(m,s({ref:t},p))}));function f(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,s=new Array(a);s[0]=d;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var l=2;l<a;l++)s[l]=n[l];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},1914:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>l});var r=n(7462),o=(n(7294),n(3905));const a={},s="Facebook Messenger connector",i={unversionedId:"Connectors/fb-connector",id:"Connectors/fb-connector",title:"Facebook Messenger connector",description:"Description",source:"@site/docs/04-Connectors/04-fb-connector.md",sourceDirName:"04-Connectors",slug:"/Connectors/fb-connector",permalink:"/Connectors/fb-connector",draft:!1,tags:[],version:"current",sidebarPosition:4,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Directline connector",permalink:"/Connectors/directline-connector"},next:{title:"Microsoft Bot Framework connector",permalink:"/Connectors/msbf-connector"}},c={},l=[{value:"Description",id:"description",level:2},{value:"Installation",id:"installation",level:2},{value:"Cards",id:"cards",level:2},{value:"Setup",id:"setup",level:2},{value:"Server",id:"server",level:3}],p={toc:l};function u(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"facebook-messenger-connector"},"Facebook Messenger connector"),(0,o.kt)("h2",{id:"description"},"Description"),(0,o.kt)("p",null,"This module is a connector for @nlp.js to facilitate the creation of bots for Facebook Messenger."),(0,o.kt)("p",null,"Under the hood, it's leveraged the official module ",(0,o.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/botbuilder-adapter-facebook"},"botbuilder-adapter-facebook"),"."),(0,o.kt)("p",null,"Communication follows this process:"),(0,o.kt)("img",{src:"https://www.plantuml.com/plantuml/png/SoWkIImgAStDuIhEpimhI2nAp5L8piyjoCzBpIi9BgdCILKeIaqkISnBpqdbuefspKjHA2rEBOfLiD6rKuXsSrBmJIqkJirBJorIA4XCJutbmYA6HMrIOd9sQbuAkdAOC4H7P7ufaaek1o05SYW0",alt:null}),(0,o.kt)("h2",{id:"installation"},"Installation"),(0,o.kt)("p",null,"You can install @nlpjs/fb-connector:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"    npm install @nlpjs/fb-connector\n")),(0,o.kt)("p",null,"This module leverages some other @nlp.js dependencies:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"@nlpjs/core"),(0,o.kt)("li",{parentName:"ul"},"@nlpjs/connector"),(0,o.kt)("li",{parentName:"ul"},"@nlpjs/bot"),(0,o.kt)("li",{parentName:"ul"},'@nlpjs/express-api-server (optional, read "Server" section)')),(0,o.kt)("h2",{id:"cards"},"Cards"),(0,o.kt)("p",null,"To be able to interact with user, aside of texts we can use Fb cards. As internal adapter communicates directly with Fb API we need to check documentation about cards into ",(0,o.kt)("a",{parentName:"p",href:"https://developers.facebook.com/docs/messenger-platform/send-messages"},"Facebook Developers site"),"."),(0,o.kt)("h2",{id:"setup"},"Setup"),(0,o.kt)("p",null,"Environment variables required to work:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"FACEBOOK_VERIFY_TOKEN=<***>\nFACEBOOK_APP_SECRET=<***>\nFACEBOOK_ACCESS_TOKEN=<***>\nFACEBOOK_PAGE_ID=<***>\n")),(0,o.kt)("p",null,"Additionally, refer to the ",(0,o.kt)("a",{parentName:"p",href:"/configuration#fb-connector"},"Facebook Messenger Connector configuration")," section\nfor more configuration options."),(0,o.kt)("h3",{id:"server"},"Server"),(0,o.kt)("p",null,"As we need to expose a backend to receive information from Facebook API, we can use express-api-server module for this.\nEvery Facebook communication adds an step where signature of message is verified. This implies generating a SHA1 signature from raw body received."),(0,o.kt)("p",null,"As express.json body parser by default takes incoming rawBody field and replaces by a parsed body field, this forces us to add a little logic to intercept incoming buffer to be able to forward rawBody to that verify step. Have in mind that this doubles memory used per message."),(0,o.kt)("p",null,"This implies to override initialize step in ExpressApiApp:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"class ExpressApiApp extends nlpjs.ExpressApiApp {\n\n  initialize() {\n    this.app = express();\n    this.app.use(express.urlencoded({ extended: false }));\n\n    this.app.use(express.json({\n      verify: (req, res, buf) => {\n        // INFO: rawBody is required for Facebook-connector\n        req.rawBody = buf;\n      }\n    }));\n    ...\n  }\n")))}u.isMDXComponent=!0}}]);